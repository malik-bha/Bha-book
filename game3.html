<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dragon vs Tiger Pro</title>
    <style>
        :root { 
            --bg: #050a18; --card-bg: #1a2238;
            --dragon: #ff3d00; --tiger: #ffea00; --tie: #00e676;
            --gold: #fcc201; --blue: #2979ff;
        }
        body { background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; overflow: hidden; user-select: none; }
        .app { width: 100%; max-width: 420px; margin: auto; height: 100vh; display: flex; flex-direction: column; }

        /* Header */
        .header { padding: 15px; display: flex; justify-content: space-between; align-items: center; background: #0f172a; border-bottom: 2px solid #1e293b; }
        .bal-val { font-size: 20px; font-weight: 900; color: var(--gold); }

        /* Board & Cards */
        .board { flex: 1; display: flex; flex-direction: column; justify-content: center; padding: 20px; gap: 30px; }
        .cards-container { display: flex; justify-content: space-around; perspective: 1000px; }
        
        .card-box { width: 90px; height: 130px; position: relative; transform-style: preserve-3d; transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .card-box.flipped { transform: rotateY(180deg); }

        .card-front, .card-back { 
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden; 
            border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 40px; font-weight: 900;
        }
        
        /* Patti (Back Side) Design */
        .card-back { background: linear-gradient(135deg, #b71c1c 25%, #880e4f 100%); border: 3px solid #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .card-back::after { content: '♠♥'; font-size: 20px; opacity: 0.3; }

        /* Asli Card (Front Side) */
        .card-front { background: white; color: black; transform: rotateY(180deg); border: 1px solid #ccc; }
        .card-front.red { color: #d32f2f; }

        /* Betting Zones */
        .zones { display: grid; grid-template-columns: 1fr 0.6fr 1fr; gap: 10px; }
        .zone { 
            height: 120px; border-radius: 15px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.3s; border: 2px solid transparent; position: relative;
        }
        .dragon { background: linear-gradient(to bottom, #7f1d1d, #ff3d00); }
        .tiger { background: linear-gradient(to bottom, #713f12, #ffea00); color: #000; }
        .tie { background: linear-gradient(to bottom, #064e3b, #00e676); font-size: 14px; }
        .zone.active { border-color: #fff; transform: scale(1.05); box-shadow: 0 0 20px #fff; }
        .winner-anim { animation: win-glow 0.5s infinite alternate; }
        @keyframes win-glow { from { box-shadow: 0 0 5px #fff; } to { box-shadow: 0 0 25px #fff; } }

        /* Controls */
        .footer { background: #0f172a; padding: 20px; border-radius: 25px 25px 0 0; }
        .chips { display: flex; justify-content: space-around; margin-bottom: 15px; }
        .chip { 
            width: 45px; height: 45px; border-radius: 50%; border: 2px dashed #fff; 
            display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold; cursor: pointer;
        }
        .chip.selected { background: var(--blue); transform: scale(1.2); border-style: solid; box-shadow: 0 0 10px var(--blue); }

        .bet-btn { width: 100%; height: 55px; border-radius: 12px; border: none; background: var(--gold); font-size: 18px; font-weight: 900; box-shadow: 0 4px 0 #b45309; }
        .bet-btn:active { transform: translateY(2px); box-shadow: none; }

        /* Popups */
        .pop-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .pop-card { background: white; color: black; width: 75%; padding: 30px; border-radius: 20px; text-align: center; }
        .confetti { position: absolute; width: 10px; height: 10px; z-index: 999; pointer-events: none; animation: fall 3s linear forwards; }
        @keyframes fall { to { transform: translateY(100vh) rotate(360deg); } }
    </style>
</head>
<body>

<div class="app">
    <div class="header">
        <div><small>WALLET</small><div id="bal-text" class="bal-val">₹0.00</div></div>
        <button onclick="loadBalance()" style="background:var(--blue); border:none; color:#fff; padding:5px 10px; border-radius:5px;">REFRESH</button>
    </div>

    <div class="board">
        <div id="msg" style="text-align:center; font-weight:bold; color:var(--gold);">PLACE YOUR BET</div>
        
        <div class="cards-container">
            <div id="box-dragon" class="card-box">
                <div class="card-back"></div>
                <div id="card-d" class="card-front">?</div>
            </div>
            <div id="box-tiger" class="card-box">
                <div class="card-back"></div>
                <div id="card-t" class="card-front">?</div>
            </div>
        </div>

        <div class="zones">
            <div class="zone dragon" onclick="selZone('dragon', this)"><b>DRAGON</b><span>1:2</span></div>
            <div class="zone tie" onclick="selZone('tie', this)"><b>TIE</b><span>1:9</span></div>
            <div class="zone tiger" onclick="selZone('tiger', this)"><b>TIGER</b><span>1:2</span></div>
        </div>
    </div>

    <div class="footer">
        <div class="chips">
            <div class="chip selected" onclick="selChip(10, this)">10</div>
            <div class="chip" onclick="selChip(50, this)">50</div>
            <div class="chip" onclick="selChip(100, this)">100</div>
            <div class="chip" onclick="selChip(500, this)">500</div>
            <div class="chip" onclick="selChip(1000, this)">1K</div>
        </div>
        <button id="play-btn" class="bet-btn" onclick="play()">START GAME</button>
    </div>
</div>

<div id="pop" class="pop-overlay">
    <div class="pop-card">
        <h1 id="pop-title" style="margin:0">WIN!</h1>
        <div id="pop-amt" style="font-size:35px; font-weight:900; margin:15px 0;">₹0.00</div>
        <button class="bet-btn" onclick="closePop()">CONTINUE</button>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzq-CozHl9G9E4FN3aoFXa2Zq8uT5kX7WOpvMgwgBYzOe-ZpqSA_HjBb85AHWi7jwg/exec";
    const mobile = localStorage.getItem("mobile");
    let balance = 0, betAmt = 10, zone = null, isLive = false;
    const cards = ["A","2","3","4","5","6","7","8","9","10","J","Q","K"];

    async function loadBalance() {
        if(!mobile) return;
        const res = await fetch(API_URL, {method:"POST", body:JSON.stringify({type:"getUser", mobile:mobile})});
        const data = await res.json();
        balance = parseFloat(data.balance);
        document.getElementById('bal-text').innerText = "₹"+balance.toFixed(2);
    }

    function selChip(a, e) {
        if(isLive) return;
        betAmt = a;
        document.querySelectorAll('.chip').forEach(c => c.classList.remove('selected'));
        e.classList.add('selected');
    }

    function selZone(z, e) {
        if(isLive) return;
        zone = z;
        document.querySelectorAll('.zone').forEach(x => x.classList.remove('active'));
        e.classList.add('active');
    }

    async function play() {
        if(!zone) { alert("Select Dragon or Tiger!"); return; }
        if(balance < betAmt) { alert("Low Balance!"); return; }

        isLive = true;
        document.getElementById('play-btn').disabled = true;
        balance -= betAmt;
        document.getElementById('bal-text').innerText = "₹"+balance.toFixed(2);
        fetch(API_URL, {method:"POST", body:JSON.stringify({type:"game", mobile:mobile, change:-betAmt})});

        // Generate results
        let d = Math.floor(Math.random()*13), t = Math.floor(Math.random()*13);
        
        // Step 1: Flip Dragon
        setTimeout(() => {
            document.getElementById('card-d').innerText = cards[d];
            document.getElementById('box-dragon').classList.add('flipped');
        }, 500);

        // Step 2: Flip Tiger
        setTimeout(() => {
            document.getElementById('card-t').innerText = cards[t];
            document.getElementById('box-tiger').classList.add('flipped');
        }, 1500);

        // Step 3: Result
        setTimeout(() => check(d, t), 2500);
    }

    async function check(d, t) {
    let win = (d > t) ? "dragon" : (t > d) ? "tiger" : "tie";
    document.querySelector('.' + win).classList.add('winner-anim');

    const popTitle = document.getElementById('pop-title');
    const popAmt = document.getElementById('pop-amt');

    if (zone === win) {
        // CASE 1: User ne sahi prediction ki (Win)
        let mult = (win === "tie") ? 9 : 2;
        let profit = betAmt * mult;
        popTitle.innerText = "CONGRATULATIONS!";
        popTitle.style.color = "green";
        popAmt.innerText = "₹" + profit.toFixed(2);
        
        for (let i = 0; i < 40; i++) spawnJhandi();
        
        await fetch(API_URL, { method: "POST", body: JSON.stringify({ type: "game", mobile: mobile, change: profit }) });
    } 
    else if (win === "tie" && (zone === "dragon" || zone === "tiger")) {
        // CASE 2: Tie ho gaya aur user ne Dragon/Tiger chuna tha (Refund)
        popTitle.innerText = "TIE - REFUNDED!";
        popTitle.style.color = "blue";
        popAmt.innerText = "₹" + betAmt.toFixed(2);
        
        // Paisa wapas bhejein
        await fetch(API_URL, { method: "POST", body: JSON.stringify({ type: "game", mobile: mobile, change: betAmt }) });
    } 
    else {
        // CASE 3: User haar gaya (Lose)
        popTitle.innerText = "YOU LOST!";
        popTitle.style.color = "red";
        popAmt.innerText = "- ₹" + betAmt;
    }

    // Balance update karein aur popup dikhayein
    loadBalance();
    document.getElementById('pop').style.display = 'flex';
}


    function spawnJhandi() {
        const colors = ['#fcc201', '#2979ff', '#ff3d00', '#00e676'];
        const j = document.createElement('div');
        j.className = 'confetti';
        j.style.left = Math.random()*100+'vw';
        j.style.background = colors[Math.floor(Math.random()*colors.length)];
        j.style.top = '-20px';
        document.body.appendChild(j);
        setTimeout(() => j.remove(), 3000);
    }

    function closePop() {
        document.getElementById('pop').style.display = 'none';
        document.getElementById('box-dragon').classList.remove('flipped');
        document.getElementById('box-tiger').classList.remove('flipped');
        document.querySelectorAll('.zone').forEach(x => x.classList.remove('winner-anim', 'active'));
        document.getElementById('play-btn').disabled = false;
        zone = null; isLive = false;
    }

    window.onload = loadBalance;
</script>
</body>
</html>
