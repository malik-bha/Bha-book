<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Deposit History</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
*{box-sizing:border-box}
body{
    margin:0;
    background:#000;
    font-family:'Poppins',sans-serif;
    color:#fff;
}
.header{
    background:#111;
    padding:15px;
    display:flex;
    align-items:center;
    border-bottom:1px solid #222;
}
.header button{
    background:none;
    border:none;
    color:#fff;
    font-size:20px;
}
.header h2{
    flex:1;
    text-align:center;
    margin:0;
    font-size:18px;
}
.card{
    background:#111;
    border-radius:16px;
    padding:15px;
    margin:15px;
    border:1px solid #222;
}
.row{
    display:flex;
    justify-content:space-between;
    align-items:center;
}
.label{
    background:#00ff88;
    color:#000;
    padding:4px 12px;
    border-radius:6px;
    font-size:12px;
    font-weight:600;
}
.badge{font-weight:600}
.green{color:#00ff88}
.yellow{color:#f4c96f}
.red{color:#ff5c5c}
.line{
    height:1px;
    background:#222;
    margin:12px 0;
}
.info{
    display:flex;
    justify-content:space-between;
    font-size:13px;
    color:#aaa;
    margin:6px 0;
}
.value{color:#fff}
.amount{color:#ff6a6a;font-weight:700}
.empty{
    text-align:center;
    margin-top:100px;
    color:#555;
}
</style>
</head>

<body>

<div class="header">
  <button onclick="history.back()">←</button>
  <h2>Deposit History</h2>
</div>

<div id="list"></div>
<div id="empty" class="empty" style="display:none">No deposit history</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzq-CozHl9G9E4FN3aoFXa2Zq8uT5kX7WOpvMgwgBYzOe-ZpqSA_HjBb85AHWi7jwg/exec";

const list = document.getElementById("list");
const empty = document.getElementById("empty");

// =======================
// LOAD LOCAL HISTORY
// =======================
let historyData = JSON.parse(localStorage.getItem("depositHistory")) || [];

function renderHistory(data) {
  if (data.length === 0) {
    empty.style.display = "block";
    return;
  }
  empty.style.display = "none";
  list.innerHTML = "";
  
  data.forEach(d => {
    
    let statusText = "To BE PAID (DON'T WORRY)";
    let statusClass = "yellow";
    let adminMsg = "⌛ Waiting for admin approval";
    
    if (d.status === "COMPLETED") {
      statusText = "Completed";
      statusClass = "green";
      adminMsg = "✔ Admin approved your payment";
    }
    else if (d.status === "FAILED") {
      statusText = "Failed";
      statusClass = "red";
      adminMsg = "✖ Payment rejected by admin";
    }
    else if (d.status === "TO_BE_PAID") {
      statusText = "To Be Paid";
      statusClass = "yellow";
      adminMsg = "⌛ Waiting for admin approval";
    }
    
    list.innerHTML += `
        <div class="card">
            <div class="row">
                <div class="label">Deposit</div>
                <div class="badge ${statusClass}">${statusText}</div>
            </div>
            <div class="line"></div>
            <div class="info">
                <span>Amount</span>
                <span class="value amount">₹${d.amount}</span>
            </div>
            <div class="info">
                <span>UTR</span>
                <span class="value">${d.utr}</span>
            </div>
            <div class="info">
                <span>Time</span>
                <span class="value">${d.time || "-"}</span>
            </div>
            <div style="font-size:12px;color:#888;margin-top:6px">
                ${adminMsg}
            </div>
        </div>`;
  });
}

renderHistory(historyData);

// =======================
// SYNC WITH GOOGLE SHEET
// =======================
async function syncWithSheet(){
    try{
        const mobile = localStorage.getItem("mobile");
        if(!mobile) return;

        const res = await fetch(
            API_URL + "?type=getDepositStatus&mobile=" + mobile
        );

        const sheetData = await res.json();

        let updated = false;

        sheetData.forEach(sheetItem=>{
            const sheetUtr = String(sheetItem.utr).replace("UTR:", "").trim();

            const localItem = historyData.find(
                h => String(h.utr).trim() === sheetUtr
            );

            if(localItem){
                if(localItem.status !== sheetItem.status){
                    localItem.status = sheetItem.status;
                    localItem.time = sheetItem.time;
                    updated = true;
                }
            }
        });

        if(updated){
            localStorage.setItem("depositHistory", JSON.stringify(historyData));
            renderHistory(historyData);
        }

    }catch(err){
        console.log("Sync failed", err);
    }
}

syncWithSheet();
</script>

</body>
</html>